<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=0.9, viewport-fit=cover" />
<link href="youtube_sample_globals.css" rel="stylesheet"/>
<link href="yotuube_sample.css" rel="stylesheet"/>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }
    body { padding-top: env(safe-area-inset-top); }
    #container {
      height: calc(var(--vh, 1vh) * 100);
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    #container::-webkit-scrollbar { display: none; }
    .video {
      position: relative;
      scroll-snap-align: end;
      height: 100vh;
      max-width: 500px;
      overflow: hidden;
    }
    .video video.video-bg {
      position: absolute;
      top: 0; left: 0;
      height: 100vh; width: 100%;
      object-fit: cover;
      z-index: 0; pointer-events: none;
    }
    .video > * { position: relative; z-index: 1; }
    #loading {
      text-align: center;
      padding: 8px;
      background: #fff;
      color: #333;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
<div id="container">
  <!-- 템플릿 -->
  <div class="video" id="video-template">
    <div class="top">
      <!-- search icon -->
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path fill="white" d="M11.458 2.60449C16.3479 2.60449 20.3123 6.56815 20.3125 11.458C20.3125 13.5275 19.6008 15.43 18.4111 16.9375L22.0908 20.6172C22.4976 21.024 22.4976 21.684 22.0908 22.0908C21.684 22.4976 21.024 22.4976 20.6172 22.0908L16.9375 18.4111C15.43 19.6008 13.5274 20.3125 11.458 20.3125C6.56815 20.3123 2.60449 16.348 2.60449 11.458C2.60465 6.56826 6.56825 2.60466 11.458 2.60449ZM11.458 4.6875C7.71885 4.68767 4.68766 7.71885 4.6875 11.458C4.6875 15.1974 7.71875 18.2293 11.458 18.2295C15.1975 18.2295 18.2295 15.1975 18.2295 11.458C18.2293 7.71874 15.1974 4.6875 11.458 4.6875Z"/></svg>
      <!-- more-vertical icon -->
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="none" viewBox="0 0 25 25"><path fill="white" d="M12.5 17.708C13.6506 17.708 14.583 18.6414 14.583 19.792C14.5828 20.9425 13.6505 21.875 12.5 21.875C11.3495 21.875 10.4172 20.9425 10.417 19.792C10.417 18.6414 11.3494 17.708 12.5 17.708ZM12.5 10.417C13.6506 10.417 14.583 11.3494 14.583 12.5C14.583 13.6506 13.6506 14.583 12.5 14.583C11.3494 14.583 10.417 13.6506 10.417 12.5C10.417 11.3494 11.3494 10.417 12.5 10.417ZM12.5 3.125C13.6505 3.12501 14.5828 4.05757 14.583 5.20801C14.583 6.3586 13.6506 7.29198 12.5 7.29199C11.3494 7.29199 10.417 6.35861 10.417 5.20801C10.4172 4.05757 11.3495 3.125 12.5 3.125Z"/></svg>
    </div>
    <div class="body">
      <div class="left">
        <div class="id">
          <div class="ellipse"></div>
          <div class="id-text"></div>
        </div>
        <p class="title-text"></p>
        <div class="music">
          <!-- music note icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="19" height="20" fill="none" viewBox="0 0 19 20"><path fill="white" d="M14.25 13.167L14.2373 13.4092C14.1158 14.6069 13.1048 15.542 11.875 15.542C10.5634 15.542 9.50016 14.4786 9.5 13.167C9.5 11.8553 10.5633 10.792 11.875 10.792C12.4839 10.792 13.0377 11.0227 13.458 11.3994V6.1582L7.52051 9.8252V15.542L7.50879 15.7842C7.38733 16.982 6.37532 17.917 5.14551 17.917C3.83407 17.9168 2.77067 16.8535 2.77051 15.542C2.77051 14.2304 3.83397 13.1672 5.14551 13.167C5.75483 13.167 6.30905 13.3982 6.72949 13.7754V7.00879L14.25 2.36328V13.167ZM5.14551 13.958C4.2712 13.9582 3.5625 14.6676 3.5625 15.542C3.56266 16.4162 4.2713 17.1248 5.14551 17.125C6.01986 17.125 6.72933 16.4163 6.72949 15.542C6.72949 14.6675 6.01996 13.958 5.14551 13.958ZM11.875 11.583C11.0005 11.583 10.292 12.2925 10.292 13.167C10.2922 14.0413 11.0006 14.75 11.875 14.75C12.7494 14.75 13.4578 14.0413 13.458 13.167C13.458 12.2925 12.7495 11.583 11.875 11.583ZM7.52051 7.4502V8.89453L13.458 5.22754V3.78223L7.52051 7.4502Z"/></svg>
          <div class="music-text"></div>
          <div class="rectangle-1"></div>
        </div>
      </div>
      <div class="right">
        <button class="button"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="25" fill="none" viewBox="0 0 26 25"><path fill="white" d="M6.22949 22.396H4.14551C3.28278 22.3959 2.58313 21.6963 2.58301 20.8335V11.4585C2.58301 10.5957 3.28271 9.89618 4.14551 9.89602H6.22949V22.396ZM12.3857 2.605C12.5693 2.33447 12.9543 2.29766 13.1855 2.52883L14.0244 3.3677C14.8371 4.18055 15.1379 5.37416 14.8076 6.47512L13.9375 9.37453H20.8125C22.2506 9.37453 23.4169 10.5408 23.417 11.979C23.417 12.9578 22.8755 13.8086 22.0771 14.2534C22.5802 14.7282 22.8955 15.3997 22.8955 16.146C22.8954 17.4058 22.001 18.4555 20.8125 18.6968V21.354C20.8125 21.9293 20.3458 22.396 19.7705 22.396H8.83301C8.25787 22.3958 7.79199 21.9292 7.79199 21.354V10.0152C7.79199 9.59804 7.91716 9.1904 8.15137 8.84524L12.3857 2.605Z"/></svg><div class="text-wrapper">LIKE</div></button>
        <button class="button"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="25" fill="none" viewBox="0 0 26 25"><path fill="white" d="M17.167 2.60449C17.742 2.60465 18.2078 3.07047 18.208 3.64551V14.9854C18.2079 15.4022 18.0827 15.8093 17.8486 16.1543L13.6143 22.3955C13.4306 22.666 13.0456 22.7028 12.8145 22.4717L11.9766 21.6328C11.1637 20.8199 10.8621 19.6255 11.1924 18.5244L12.0625 15.625H5.1875C3.74926 15.625 2.58301 14.4587 2.58301 13.0205C2.58315 12.0419 3.1237 11.19 3.92188 10.7451C3.41961 10.2705 3.10458 9.60009 3.10449 8.85449C3.10449 7.5946 3.99881 6.54303 5.1875 6.30176V3.64551C5.18768 3.07037 5.65431 2.60449 6.22949 2.60449H17.167ZM21.8545 2.60449C22.7173 2.60464 23.417 3.30414 23.417 4.16699V13.542C23.4168 14.4047 22.7172 15.1043 21.8545 15.1045H19.7705V2.60449H21.8545Z"/></svg><div class="text-wrapper">싫어요</div></button>
        <button class="button btn-comment"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="25" fill="none" viewBox="0 0 26 25"><g clip-path="url(#clip0_10_42)"><path fill="white" fill-rule="evenodd" clip-rule="evenodd" d="M3.27778 0C1.74365 0 0.5 1.24775 0.5 2.78694V17.4184C0.5 18.9575 1.74365 20.2053 3.27778 20.2053H19.25L23.7218 24.6918C24.378 25.3502 25.5 24.8839 25.5 23.9528V17.4184V2.78694C25.5 1.24775 24.2563 0 22.7222 0H3.27778ZM5.36111 6.96734C5.36111 6.19775 5.98294 5.57387 6.75 5.57387H19.25C20.0171 5.57387 20.6389 6.19775 20.6389 6.96734C20.6389 7.73693 20.0171 8.36081 19.25 8.36081H6.75C5.98294 8.36081 5.36111 7.73693 5.36111 6.96734ZM6.75 11.8445C5.98294 11.8445 5.36111 12.4684 5.36111 13.238C5.36111 14.0075 5.98294 14.6314 6.75 14.6314H15.0833C15.8504 14.6314 16.4722 14.0075 16.4722 13.238C16.4722 12.4684 15.8504 11.8445 15.0833 11.8445H6.75Z"/></g><defs><clipPath id="clip0_10_42"><rect width="26" height="25" fill="white"/></clipPath></defs></svg><div class="text-wrapper">999</div></button>
        <button class="button btn-hide-category"><svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 0C19.116 0 24.4792 5.36326 24.4792 11.9792C24.4792 18.5951 19.116 23.9583 12.5 23.9583C5.88413 23.9583 0.520874 18.5951 0.520874 11.9792C0.520874 5.36326 5.88413 0 12.5 0ZM12.5 10.097L8.11704 5.71402L6.2349 7.59616L10.6179 11.9792L6.2349 16.3622L8.11704 18.2443L12.5 13.8613L16.883 18.2443L18.7652 16.3622L14.3822 11.9792L18.7652 7.59616L16.883 5.71402L12.5 10.097Z" fill="white"/></svg><div class="text-wrapper">관심없음</div></button>
        <div class="rectangle"></div>
      </div>
    </div>
  </div>
  <div id="loading">로딩 중...</div>
</div>

<script>
/* ----------------- 공통 유틸 ----------------- */
function setRealHeight() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setRealHeight);
window.addEventListener('load', setRealHeight);

/* ----------------- 데이터/상태 ----------------- */
/* 1) 카테고리 정의 + 무작위 셔플 */
let categories = ['tesla', 'dog', 'aot'];

// Fisher–Yates shuffle
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
// 페이지 로드시 카테고리 순서 랜덤
categories = shuffle(categories);

const hiddenCategories = new Map(); // key: 카테고리, value: timestamp

const container = document.getElementById('container');
const loading = document.getElementById('loading');
const template = document.getElementById('video-template');
if (!container || !loading || !template) {
  console.error("필수 DOM 요소(container/loading/template)를 찾을 수 없습니다.");
}
template.removeAttribute('id');
container?.removeChild(template);

/* ----------------- CSV 파싱 ----------------- */
function parseCSV(text) {
  text = text.replace(/^\uFEFF/, ''); // BOM 제거
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h => h.trim());
  return lines.slice(1).map(line => {
    const cols = line.split(',').map(c => c.trim());
    const o = {};
    headers.forEach((h, i) => (o[h] = cols[i] || ''));
    return o;
  });
}

/* ----------------- 카테고리 숨김 ----------------- */
function hideCategory(cat) {
  if (!cat || !container) return;
  hiddenCategories.set(cat, Date.now());
  [...container.querySelectorAll(`.video[data-category="${cat}"]`)].forEach(el => {
    const vid = el.querySelector('video');
    if (vid) { vid.pause(); vid.src = ''; }
    el.remove();
  });
  updateVideosAfterHide();
}
function isCategoryHidden(cat) {
  if (!hiddenCategories.has(cat)) return false;
  const hiddenAt = hiddenCategories.get(cat);
  if (Date.now() - hiddenAt > 120000) { // 2분 후 복구
    hiddenCategories.delete(cat);
    return false;
  }
  return true;
}
function restoreOldestCategory() {
  let oldest = null, oldestTime = Infinity;
  for (let [cat, time] of hiddenCategories) {
    if (time < oldestTime) { oldest = cat; oldestTime = time; }
  }
  if (oldest) hiddenCategories.delete(oldest);
  return oldest;
}
function updateVideosAfterHide() {
  const visibleCats = categories.filter(c => !isCategoryHidden(c));
  if (visibleCats.length === 0) {
    const restored = restoreOldestCategory();
    if (restored) {
      console.log(`모든 카테고리가 숨겨져서 ${restored} 카테고리를 복구합니다.`);
      reloadVideos();
    }
  } else {
    reloadVideos();
  }
}

/* ----------------- 포스트 생성 ----------------- */
function createPost(data) {
  const post = template.cloneNode(true);
  post.dataset.category = data._category || '';

  // 비디오
  const bg = document.createElement('video');
  bg.className = 'video-bg';
  bg.setAttribute('data-src', data['MP4 URL']);
  bg.autoplay = true;
  bg.loop = true;
  bg.playsInline = true;
  bg.muted = true;          // 초기엔 항상 mute
  bg.preload = "none";
  post.prepend(bg);

  post.querySelector('.id-text').textContent = data['ID'];
  post.querySelector('.title-text').textContent = data['TITLE'];
  post.querySelector('.music-text').textContent = data['MUSIC'];
  const cc = post.querySelector('.comment-count');
  if (cc) cc.textContent = data['COMMENT'] || '';

  const hideBtn = post.querySelector('.btn-hide-category');
  if (hideBtn) {
    hideBtn.addEventListener('click', e => {
      e.stopPropagation();
      hideCategory(post.dataset.category);
    });
  }

  return post;
}

/* ----------------- 데이터 로드 ----------------- */
let allVideosCache = [];
async function loadAll() {
  try {
    const results = await Promise.all(categories.map(async cat => {
      try {
        const res = await fetch(`${cat}.csv`);
        if (!res.ok) throw new Error(`${cat}.csv 로드 실패`);
        const text = await res.text();
        // 카테고리 내부도 랜덤
        const rows = parseCSV(text).map(r => ({ ...r, _category: cat }));
        return shuffle(rows);
      } catch (err) {
        console.error(err);
        return [];
      }
    }));

    // 최종 전체도 랜덤(카테고리 섞임 + 각 카테고리 내부 섞임 + 전체 섞임)
    allVideosCache = shuffle(results.flat());

    reloadVideos();

    loading.style.display = 'none';
    observeVideos();
  } catch (err) {
    console.error("데이터 로드 실패:", err);
    loading.textContent = "데이터를 불러오지 못했습니다.";
  }
}

/* ----------------- 렌더/리로드 ----------------- */
function reloadVideos() {
  if (!container) return;
  container.innerHTML = '';

  allVideosCache
    .filter(row => !isCategoryHidden(row._category))
    .forEach(row => container.appendChild(createPost(row)));

  observeVideos();
  // 리로드 직후 오디오 정책 적용(초기엔 전부 mute)
  applyAudioPolicy();
}

/* ----------------- 오디오 정책 ----------------- */
// 사용자 제스처 확보 여부
let userGestureGranted = false;

// 현재 data-active="true" 비디오
function getActiveVideo() {
  return document.querySelector('.video video.video-bg[data-active="true"]');
}

// 한 번에 하나만 소리
function applyAudioPolicy() {
  const videos = document.querySelectorAll('.video video.video-bg');
  const active = getActiveVideo();

  videos.forEach(v => { v.muted = true; });

  if (userGestureGranted && active) {
    active.muted = false;
    if (active.paused) active.play().catch(()=>{});
  }
}

/* ----------------- IntersectionObserver ----------------- */
let observer;
function observeVideos() {
  if (!container) return;
  if (observer) observer.disconnect();

  observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = entry.target;
      if (!(video instanceof HTMLVideoElement)) return;

      if (entry.isIntersecting) {
        if (!video.src && video.dataset.src) video.src = video.dataset.src;
        video.setAttribute('data-active', 'true');

        document.querySelectorAll('.video video.video-bg').forEach(v => {
          if (v !== video) v.removeAttribute('data-active');
        });

        video.play().catch(()=>{});
      } else {
        video.removeAttribute('data-active');
        video.pause();
      }
    });

    applyAudioPolicy();
  }, { threshold: 0.75 });

  document.querySelectorAll('.video video.video-bg').forEach(v => observer.observe(v));
}

/* ----------------- 스크롤 스냅(한 장씩) ----------------- */
let isScrolling = false;
container?.addEventListener('wheel', (e) => {
  e.preventDefault();
  if (isScrolling) return;
  isScrolling = true;

  const direction = e.deltaY > 0 ? 1 : -1;
  const videos = [...container.querySelectorAll('.video')];
  const currentScroll = container.scrollTop;
  const viewHeight = container.clientHeight;

  let currentIndex = videos.findIndex(
    v => Math.abs(v.offsetTop - currentScroll) < viewHeight / 2
  );
  if (currentIndex === -1) {
    currentIndex = Math.round(currentScroll / viewHeight);
  }

  const targetIndex = Math.max(0, Math.min(videos.length - 1, currentIndex + direction));
  const targetOffset = videos[targetIndex]?.offsetTop ?? 0;
  container.scrollTo({ top: targetOffset, behavior: 'smooth' });

  setTimeout(() => { isScrolling = false; }, 600);
}, { passive: false });

/* ----------------- 사용자 제스처 이벤트 ----------------- */
window.addEventListener('touchstart', () => {
  userGestureGranted = true;
  applyAudioPolicy();
}, { once: true });

window.addEventListener('click', () => {
  userGestureGranted = true;
  applyAudioPolicy();
}, { once: false });

/* ----------------- 시작 ----------------- */
loadAll();
</script>
</body>
</html>


